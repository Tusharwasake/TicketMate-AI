<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Diagnostics - TicketMate AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Backend Diagnostics</h1>
                <p class="text-gray-600">Testing connection to TicketMate AI backend</p>
            </div>

            <!-- Status Cards -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Local Backend -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                        Local Backend
                    </h3>
                    <div id="local-status" class="text-sm text-gray-600">Testing...</div>
                    <div class="mt-2 text-xs text-gray-500">localhost:4000</div>
                </div>

                <!-- Production Backend -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                        Production Backend
                    </h3>
                    <div id="prod-status" class="text-sm text-gray-600">Testing...</div>
                    <div class="mt-2 text-xs text-gray-500">ticketmate-ai.onrender.com</div>
                </div>

                <!-- CORS Test -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <div class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                        CORS Test
                    </h3>
                    <div id="cors-status" class="text-sm text-gray-600">Testing...</div>
                    <div class="mt-2 text-xs text-gray-500">Cross-origin requests</div>
                </div>
            </div>

            <!-- Detailed Logs -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Detailed Test Results</h3>
                <div id="detailed-logs" class="bg-gray-50 p-4 rounded text-sm font-mono max-h-96 overflow-y-auto">
                    Starting diagnostics...
                </div>
            </div>

            <!-- Manual Tests -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Manual API Tests</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <button id="test-signup" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600 transition-colors">
                        Test Signup API
                    </button>
                    <button id="test-login" class="bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600 transition-colors">
                        Test Login API
                    </button>
                    <button id="test-tickets" class="bg-purple-500 text-white py-3 px-4 rounded hover:bg-purple-600 transition-colors">
                        Test Tickets API
                    </button>
                    <button id="wake-render" class="bg-orange-500 text-white py-3 px-4 rounded hover:bg-orange-600 transition-colors">
                        Wake Render Server
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            
            const logsDiv = document.getElementById('detailed-logs');
            logsDiv.innerHTML = logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'success' ? 'text-green-600' : 
                               status === 'error' ? 'text-red-600' : 'text-yellow-600';
            const icon = status === 'success' ? '✅' : status === 'error' ? '❌' : '⚠️';
            
            element.innerHTML = `<span class="${statusClass}">${icon} ${message}</span>`;
        }

        async function testBackend(url, label) {
            try {
                addLog(`Testing ${label} at ${url}`);
                
                // Test health endpoint
                const healthResponse = await fetch(`${url}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (healthResponse.ok) {
                    const data = await healthResponse.json();
                    addLog(`${label} health check: SUCCESS - ${JSON.stringify(data)}`, 'success');
                    return { success: true, data };
                } else {
                    addLog(`${label} health check: FAILED - HTTP ${healthResponse.status}`, 'error');
                    return { success: false, error: `HTTP ${healthResponse.status}` };
                }
            } catch (error) {
                addLog(`${label} connection: FAILED - ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testCORS() {
            const prodUrl = 'https://ticketmate-ai.onrender.com/api';
            
            try {
                addLog('Testing CORS with OPTIONS request');
                
                const response = await fetch(`${prodUrl}/test`, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Origin': 'https://aiagentticket.netlify.app',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                addLog(`CORS preflight response: ${response.status} ${response.statusText}`, 
                       response.ok ? 'success' : 'error');
                
                return response.ok;
            } catch (error) {
                addLog(`CORS test failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function runDiagnostics() {
            addLog('Starting backend diagnostics...');
            
            // Test local backend
            const localResult = await testBackend('http://localhost:4000/api', 'Local Backend');
            updateStatus('local-status', 
                        localResult.success ? 'success' : 'error', 
                        localResult.success ? 'Connected' : 'Failed');
            
            // Test production backend
            const prodResult = await testBackend('https://ticketmate-ai.onrender.com/api', 'Production Backend');
            updateStatus('prod-status', 
                        prodResult.success ? 'success' : 'error', 
                        prodResult.success ? 'Connected' : prodResult.error);
            
            // Test CORS
            const corsResult = await testCORS();
            updateStatus('cors-status', 
                        corsResult ? 'success' : 'error', 
                        corsResult ? 'Working' : 'Failed');
            
            addLog('Diagnostics complete!');
        }

        // Manual test functions
        document.getElementById('test-signup').addEventListener('click', async () => {
            const url = 'https://ticketmate-ai.onrender.com/api/auth/signup';
            const testData = {
                email: `test-${Date.now()}@example.com`,
                password: '123456',
                role: 'user'
            };
            
            try {
                addLog('Testing signup API...');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.text();
                addLog(`Signup test: ${response.status} - ${result}`, 
                       response.ok ? 'success' : 'error');
            } catch (error) {
                addLog(`Signup test failed: ${error.message}`, 'error');
            }
        });

        document.getElementById('test-login').addEventListener('click', async () => {
            const url = 'https://ticketmate-ai.onrender.com/api/auth/login';
            const testData = {
                email: 'test@gmail.com',
                password: '123456'
            };
            
            try {
                addLog('Testing login API...');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.text();
                addLog(`Login test: ${response.status} - ${result}`, 
                       response.ok ? 'success' : 'error');
            } catch (error) {
                addLog(`Login test failed: ${error.message}`, 'error');
            }
        });

        document.getElementById('test-tickets').addEventListener('click', async () => {
            const url = 'https://ticketmate-ai.onrender.com/api/tickets';
            
            try {
                addLog('Testing tickets API...');
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.text();
                addLog(`Tickets test: ${response.status} - ${result}`, 
                       response.ok ? 'success' : 'error');
            } catch (error) {
                addLog(`Tickets test failed: ${error.message}`, 'error');
            }
        });

        document.getElementById('wake-render').addEventListener('click', async () => {
            addLog('Attempting to wake Render server...');
            
            // Try multiple endpoints to wake the server
            const endpoints = [
                'https://ticketmate-ai.onrender.com/health',
                'https://ticketmate-ai.onrender.com/api/health',
                'https://ticketmate-ai.onrender.com/test'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    addLog(`Pinging ${endpoint}...`);
                    const response = await fetch(endpoint, { method: 'GET' });
                    addLog(`Response: ${response.status}`, response.ok ? 'success' : 'warning');
                    
                    if (response.ok) break; // Stop if we get a successful response
                } catch (error) {
                    addLog(`Failed to reach ${endpoint}: ${error.message}`, 'warning');
                }
                
                // Wait 2 seconds between requests
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            addLog('Wake attempt complete. Server should be starting up...');
        });

        // Run diagnostics on page load
        runDiagnostics();
        
        // Re-run diagnostics every 30 seconds
        setInterval(runDiagnostics, 30000);
    </script>
</body>
</html>
