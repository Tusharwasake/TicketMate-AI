<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketMate AI - Complete Flow Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">TicketMate AI</h1>
                <p class="text-xl text-gray-600">Complete Flow Testing</p>
                <div id="timestamp" class="text-sm text-gray-500 mt-2"></div>
            </div>

            <!-- Test Progress -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4">Flow Test Progress</h2>
                <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="progress-fill" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="current-step" class="text-center text-gray-600">Ready to start testing...</div>
            </div>

            <!-- Test Results -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- Signup Flow Tests -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <div class="w-4 h-4 rounded-full bg-blue-500 mr-3"></div>
                        Signup Flow Tests
                    </h3>
                    <div id="signup-tests" class="space-y-3">
                        <div class="text-gray-500">Waiting to start...</div>
                    </div>
                </div>

                <!-- Login Flow Tests -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <div class="w-4 h-4 rounded-full bg-green-500 mr-3"></div>
                        Login Flow Tests
                    </h3>
                    <div id="login-tests" class="space-y-3">
                        <div class="text-gray-500">Waiting to start...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Tests -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <div class="w-4 h-4 rounded-full bg-purple-500 mr-3"></div>
                    Profile Management Tests
                </h3>
                <div id="profile-tests" class="space-y-3">
                    <div class="text-gray-500">Waiting to start...</div>
                </div>
            </div>

            <!-- Manual Test Actions -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">Manual Test Actions</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="btn-auto-test" class="bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        ü§ñ Auto Test
                    </button>
                    <button id="btn-test-signup" class="bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        üìù Test Signup
                    </button>
                    <button id="btn-test-login" class="bg-purple-500 text-white py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                        üîê Test Login
                    </button>
                    <button id="btn-test-profile" class="bg-orange-500 text-white py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        üë§ Test Profile
                    </button>
                </div>
            </div>

            <!-- Test Log -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">Test Log</h3>
                <div id="test-log" class="bg-gray-50 rounded p-4 h-64 overflow-y-auto text-sm font-mono">
                    <div class="text-gray-500">Test log will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        const FRONTEND_BASE = 'http://localhost:5173';
        
        let testResults = {
            signup: {},
            login: {},
            profile: {}
        };
        
        let currentProgress = 0;
        let totalTests = 12;

        // Update timestamp
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }
        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700';
            
            const logEntry = document.createElement('div');
            logEntry.className = `${color} mb-1`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Progress update
        function updateProgress(step, total) {
            currentProgress = step;
            const percentage = (step / total) * 100;
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('current-step').textContent = `Step ${step} of ${total}`;
        }

        // Create test result item
        function createTestItem(name, status, message) {
            const statusIcon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : status === 'pending' ? '‚è≥' : '‚ö†Ô∏è';
            const statusColor = status === 'pass' ? 'text-green-600' : status === 'fail' ? 'text-red-600' : 'text-yellow-600';
            
            return `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${statusIcon}</span>
                        <span class="font-medium">${name}</span>
                    </div>
                    <span class="text-sm ${statusColor}">${message}</span>
                </div>
            `;
        }

        // Test functions
        async function testServerConnectivity() {
            log('Testing server connectivity...');
            updateProgress(1, totalTests);
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    testResults.signup.serverConnectivity = { status: 'pass', message: `DB: ${data.database}` };
                    log('‚úÖ Server connectivity test passed', 'success');
                } else {
                    testResults.signup.serverConnectivity = { status: 'fail', message: `HTTP ${response.status}` };
                    log('‚ùå Server connectivity test failed', 'error');
                }
            } catch (error) {
                testResults.signup.serverConnectivity = { status: 'fail', message: 'Connection failed' };
                log(`‚ùå Server connectivity error: ${error.message}`, 'error');
            }
        }

        async function testSignupEndpoint() {
            log('Testing signup endpoint...');
            updateProgress(2, totalTests);
            
            const testEmail = `test-${Date.now()}@example.com`;
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: testEmail,
                        password: 'TestPassword123!',
                        role: 'moderator'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testResults.signup.endpoint = { status: 'pass', message: 'Account created' };
                    testResults.signup.testUser = { email: testEmail, password: 'TestPassword123!' };
                    log(`‚úÖ Signup endpoint test passed - User: ${testEmail}`, 'success');
                } else {
                    const errorData = await response.json();
                    testResults.signup.endpoint = { status: 'fail', message: errorData.message || `HTTP ${response.status}` };
                    log(`‚ùå Signup endpoint test failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                testResults.signup.endpoint = { status: 'fail', message: 'Request failed' };
                log(`‚ùå Signup endpoint error: ${error.message}`, 'error');
            }
        }

        async function testSignupRedirection() {
            log('Testing signup page accessibility...');
            updateProgress(3, totalTests);
            
            try {
                const response = await fetch(`${FRONTEND_BASE}/signup`);
                if (response.ok) {
                    testResults.signup.pageAccess = { status: 'pass', message: 'Page accessible' };
                    log('‚úÖ Signup page accessibility test passed', 'success');
                } else {
                    testResults.signup.pageAccess = { status: 'fail', message: `HTTP ${response.status}` };
                    log('‚ùå Signup page accessibility test failed', 'error');
                }
            } catch (error) {
                testResults.signup.pageAccess = { status: 'fail', message: 'Page not accessible' };
                log(`‚ùå Signup page error: ${error.message}`, 'error');
            }
        }

        async function testLoginEndpoint() {
            log('Testing login endpoint...');
            updateProgress(4, totalTests);
            
            if (!testResults.signup.testUser) {
                testResults.login.endpoint = { status: 'fail', message: 'No test user available' };
                log('‚ùå Login test skipped - no test user', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: testResults.signup.testUser.email,
                        password: testResults.signup.testUser.password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testResults.login.endpoint = { status: 'pass', message: 'Login successful' };
                    testResults.login.token = data.token;
                    testResults.login.user = data.user;
                    log('‚úÖ Login endpoint test passed', 'success');
                } else {
                    const errorData = await response.json();
                    testResults.login.endpoint = { status: 'fail', message: errorData.message || `HTTP ${response.status}` };
                    log(`‚ùå Login endpoint test failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                testResults.login.endpoint = { status: 'fail', message: 'Request failed' };
                log(`‚ùå Login endpoint error: ${error.message}`, 'error');
            }
        }

        async function testTokenValidation() {
            log('Testing JWT token validation...');
            updateProgress(5, totalTests);
            
            if (!testResults.login.token) {
                testResults.login.tokenValidation = { status: 'fail', message: 'No token available' };
                log('‚ùå Token validation skipped - no token', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${testResults.login.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ skills: ['Test Skill'] })
                });
                
                if (response.ok || response.status === 200) {
                    testResults.login.tokenValidation = { status: 'pass', message: 'Token valid' };
                    log('‚úÖ Token validation test passed', 'success');
                } else if (response.status === 401) {
                    testResults.login.tokenValidation = { status: 'fail', message: 'Token invalid' };
                    log('‚ùå Token validation test failed - invalid token', 'error');
                } else {
                    testResults.login.tokenValidation = { status: 'warning', message: `HTTP ${response.status}` };
                    log(`‚ö†Ô∏è Token validation unclear - HTTP ${response.status}`, 'info');
                }
            } catch (error) {
                testResults.login.tokenValidation = { status: 'fail', message: 'Request failed' };
                log(`‚ùå Token validation error: ${error.message}`, 'error');
            }
        }

        async function testProfilePageAccess() {
            log('Testing profile page accessibility...');
            updateProgress(6, totalTests);
            
            try {
                const response = await fetch(`${FRONTEND_BASE}/profile`);
                if (response.ok) {
                    testResults.profile.pageAccess = { status: 'pass', message: 'Page accessible' };
                    log('‚úÖ Profile page accessibility test passed', 'success');
                } else {
                    testResults.profile.pageAccess = { status: 'fail', message: `HTTP ${response.status}` };
                    log('‚ùå Profile page accessibility test failed', 'error');
                }
            } catch (error) {
                testResults.profile.pageAccess = { status: 'fail', message: 'Page not accessible' };
                log(`‚ùå Profile page error: ${error.message}`, 'error');
            }
        }

        async function testProfileComponentImport() {
            log('Testing Profile component import...');
            updateProgress(7, totalTests);
            
            try {
                const profileModule = await import('/src/pages/Profile.jsx');
                if (profileModule.default && typeof profileModule.default === 'function') {
                    testResults.profile.componentImport = { status: 'pass', message: 'Import successful' };
                    log('‚úÖ Profile component import test passed', 'success');
                } else {
                    testResults.profile.componentImport = { status: 'fail', message: 'No default export' };
                    log('‚ùå Profile component import test failed', 'error');
                }
            } catch (error) {
                testResults.profile.componentImport = { status: 'fail', message: error.message.substring(0, 30) + '...' };
                log(`‚ùå Profile component import error: ${error.message}`, 'error');
            }
        }

        async function testSkillsUpdate() {
            log('Testing skills update API...');
            updateProgress(8, totalTests);
            
            if (!testResults.login.token) {
                testResults.profile.skillsUpdate = { status: 'fail', message: 'No auth token' };
                log('‚ùå Skills update skipped - no token', 'error');
                return;
            }
            
            try {
                const testSkills = ['JavaScript', 'React', 'Node.js', 'Flow Test Skill'];
                const response = await fetch(`${API_BASE}/api/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${testResults.login.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ skills: testSkills })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testResults.profile.skillsUpdate = { status: 'pass', message: `${testSkills.length} skills updated` };
                    log(`‚úÖ Skills update test passed - ${testSkills.length} skills`, 'success');
                } else {
                    const errorData = await response.json();
                    testResults.profile.skillsUpdate = { status: 'fail', message: errorData.message || `HTTP ${response.status}` };
                    log(`‚ùå Skills update test failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                testResults.profile.skillsUpdate = { status: 'fail', message: 'Request failed' };
                log(`‚ùå Skills update error: ${error.message}`, 'error');
            }
        }

        async function testStorageUtility() {
            log('Testing storage utility...');
            updateProgress(9, totalTests);
            
            try {
                localStorage.setItem('__flow_test__', 'test-value');
                const value = localStorage.getItem('__flow_test__');
                localStorage.removeItem('__flow_test__');
                
                if (value === 'test-value') {
                    testResults.profile.storage = { status: 'pass', message: 'Working correctly' };
                    log('‚úÖ Storage utility test passed', 'success');
                } else {
                    testResults.profile.storage = { status: 'fail', message: 'Read/write failed' };
                    log('‚ùå Storage utility test failed', 'error');
                }
            } catch (error) {
                testResults.profile.storage = { status: 'fail', message: 'Access denied' };
                log(`‚ùå Storage utility error: ${error.message}`, 'error');
            }
        }

        async function testRouteProtection() {
            log('Testing route protection...');
            updateProgress(10, totalTests);
            
            try {
                // Test accessing profile without token
                const response = await fetch(`${API_BASE}/api/auth/profile`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ skills: ['Test'] })
                });
                
                if (response.status === 401) {
                    testResults.profile.routeProtection = { status: 'pass', message: 'Protected correctly' };
                    log('‚úÖ Route protection test passed', 'success');
                } else {
                    testResults.profile.routeProtection = { status: 'fail', message: `Expected 401, got ${response.status}` };
                    log(`‚ùå Route protection test failed - got ${response.status}`, 'error');
                }
            } catch (error) {
                testResults.profile.routeProtection = { status: 'fail', message: 'Request failed' };
                log(`‚ùå Route protection error: ${error.message}`, 'error');
            }
        }

        async function testEndToEndFlow() {
            log('Testing end-to-end flow completion...');
            updateProgress(11, totalTests);
            
            const signupPassed = testResults.signup.endpoint?.status === 'pass';
            const loginPassed = testResults.login.endpoint?.status === 'pass';
            const profilePassed = testResults.profile.skillsUpdate?.status === 'pass';
            
            if (signupPassed && loginPassed && profilePassed) {
                testResults.profile.endToEnd = { status: 'pass', message: 'Complete flow working' };
                log('‚úÖ End-to-end flow test passed', 'success');
            } else {
                const failedSteps = [];
                if (!signupPassed) failedSteps.push('signup');
                if (!loginPassed) failedSteps.push('login');
                if (!profilePassed) failedSteps.push('profile');
                
                testResults.profile.endToEnd = { status: 'fail', message: `Failed: ${failedSteps.join(', ')}` };
                log(`‚ùå End-to-end flow test failed: ${failedSteps.join(', ')}`, 'error');
            }
        }

        async function generateSummary() {
            log('Generating test summary...');
            updateProgress(12, totalTests);
            
            const allTests = [
                ...Object.values(testResults.signup),
                ...Object.values(testResults.login),
                ...Object.values(testResults.profile)
            ];
            
            const passed = allTests.filter(t => t.status === 'pass').length;
            const failed = allTests.filter(t => t.status === 'fail').length;
            const warnings = allTests.filter(t => t.status === 'warning').length;
            
            log(`üìä Test Summary: ${passed} passed, ${failed} failed, ${warnings} warnings`, 'info');
            
            if (failed === 0) {
                log('üéâ ALL TESTS PASSED! The signup to profile flow is working correctly.', 'success');
            } else {
                log(`‚ö†Ô∏è ${failed} test(s) failed. Please check the issues above.`, 'error');
            }
        }

        // Update UI with test results
        function updateUI() {
            // Update signup tests
            const signupHTML = Object.entries(testResults.signup)
                .map(([key, result]) => createTestItem(
                    key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()),
                    result.status,
                    result.message
                )).join('');
            document.getElementById('signup-tests').innerHTML = signupHTML || '<div class="text-gray-500">No tests run yet</div>';
            
            // Update login tests
            const loginHTML = Object.entries(testResults.login)
                .map(([key, result]) => createTestItem(
                    key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()),
                    result.status,
                    result.message
                )).join('');
            document.getElementById('login-tests').innerHTML = loginHTML || '<div class="text-gray-500">No tests run yet</div>';
            
            // Update profile tests
            const profileHTML = Object.entries(testResults.profile)
                .map(([key, result]) => createTestItem(
                    key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()),
                    result.status,
                    result.message
                )).join('');
            document.getElementById('profile-tests').innerHTML = profileHTML || '<div class="text-gray-500">No tests run yet</div>';
        }

        // Run all tests
        async function runAllTests() {
            log('üöÄ Starting complete flow test...', 'info');
            
            try {
                await testServerConnectivity();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testSignupEndpoint();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testSignupRedirection();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testLoginEndpoint();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testTokenValidation();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testProfilePageAccess();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testProfileComponentImport();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testSkillsUpdate();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testStorageUtility();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testRouteProtection();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testEndToEndFlow();
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await generateSummary();
                
                document.getElementById('current-step').textContent = 'Tests completed!';
                log('‚úÖ All tests completed successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Test execution error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('btn-auto-test').addEventListener('click', runAllTests);
        document.getElementById('btn-test-signup').addEventListener('click', () => {
            window.open(`${FRONTEND_BASE}/signup`, '_blank');
        });
        document.getElementById('btn-test-login').addEventListener('click', () => {
            window.open(`${FRONTEND_BASE}/login`, '_blank');
        });
        document.getElementById('btn-test-profile').addEventListener('click', () => {
            window.open(`${FRONTEND_BASE}/profile`, '_blank');
        });

        // Auto-run tests on page load
        setTimeout(runAllTests, 1000);
    </script>
</body>
</html>
